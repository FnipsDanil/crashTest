# üé´ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è Crash Stars Game

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∞–±—å—é–∑–æ–≤ –∏ –≥–∏–±–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

## üöÄ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **Backend API** (`/api/player/use-promo-code`, `/api/player/promo-code-history`)
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** (—Ç–∞–±–ª–∏—Ü—ã `promo_codes`, `promo_code_uses`)
3. **Frontend UI** (–ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ü—Ä–æ—Ñ–∏–ª—å ‚Üí –ë–æ–Ω—É—Å—ã)
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (Redis locks, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
5. **–ê—É–¥–∏—Ç** (–ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `transactions`)

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

- **N –∞–∫—Ç–∏–≤–∞—Ü–∏–π** - –∫–∞–∂–¥—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- **1 –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤—ã–≤–æ–¥—É** - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ –¥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- **–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞** - –ø—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞** - —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã A-Z –∏ —Ü–∏—Ñ—Ä—ã 0-9

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `promo_codes`
```sql
- id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–º–æ–∫–æ–¥–∞
- code: –ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, 3-50 —Å–∏–º–≤–æ–ª–æ–≤)
- balance_reward: –†–∞–∑–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã –≤ –∑–≤—ë–∑–¥–∞—Ö
- withdrawal_requirement: –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é –¥–ª—è –≤—ã–≤–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- max_uses: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π
- current_uses: –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- is_active: –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
- created_at: –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- expires_at: –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### –¢–∞–±–ª–∏—Ü–∞ `promo_code_uses`
```sql
- id: ID –∑–∞–ø–∏—Å–∏ –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- promo_code_id: –°–≤—è–∑—å —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
- user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- balance_granted: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –∑–≤—ë–∑–¥
- withdrawal_requirement: –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –≤—ã–≤–æ–¥—É –Ω–∞ –º–æ–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- used_at: –î–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

### –ü–æ–ª–µ `users.withdrawal_locked_balance`
–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–ª—å–∑—è –≤—ã–≤–µ—Å—Ç–∏ –¥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
cd backend
alembic upgrade head
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
```bash
psql -d crash_stars_db -f test_promo_codes.sql
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```bash
# Backend
cd backend
python main.py

# Frontend  
cd frontend
npm run dev
```

## üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (SQL)
```sql
INSERT INTO promo_codes (
    code, 
    balance_reward, 
    withdrawal_requirement, 
    max_uses, 
    is_active,
    expires_at
) VALUES (
    'WELCOME100',     -- –∫–æ–¥
    100.00,           -- 100 –∑–≤—ë–∑–¥ –Ω–∞–≥—Ä–∞–¥–∞
    NULL,            -- –±–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –≤—ã–≤–æ–¥—É
    1000,            -- 1000 –∞–∫—Ç–∏–≤–∞—Ü–∏–π
    true,            -- –∞–∫—Ç–∏–≤–µ–Ω
    NULL             -- –±–µ–∑ –∏—Å—Ç–µ—á–µ–Ω–∏—è
);
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
1. –ó–∞–π—Ç–∏ –≤ **–ü—Ä–æ—Ñ–∏–ª—å** ‚Üí **–ë–æ–Ω—É—Å—ã**
2. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –ø–æ–ª–µ
3. –ù–∞–∂–∞—Ç—å **"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"**

### API endpoints

#### `POST /api/player/use-promo-code`
```json
{
  "promo_code": "WELCOME100"
}
```

–û—Ç–≤–µ—Ç:
```json
{
  "s": true,
  "a": "100.00",
  "b": "1100.00", 
  "c": "WELCOME100",
  "wr": null
}
```

#### `GET /api/player/promo-code-history`
–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–æ–≤:
- **Redis locks** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –æ–¥–∏–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞** - —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Telegram Mini App
- **–ê—É–¥–∏—Ç** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ü—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- –ú–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫–æ–¥–µ
- –¢–æ–ª—å–∫–æ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

## üéÆ –õ–æ–≥–∏–∫–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

### –ë–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é:
```
–ü—Ä–æ–º–æ–∫–æ–¥: WELCOME100 (100 –∑–≤—ë–∑–¥)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –≤—ã–≤–µ—Å—Ç–∏ –≤—Å–µ 100 –∑–≤—ë–∑–¥
```

### –° —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é:
```
–ü—Ä–æ–º–æ–∫–æ–¥: BONUS50 (50 –∑–≤—ë–∑–¥, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 50)
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 50 –∑–≤—ë–∑–¥ –Ω–∞ –±–∞–ª–∞–Ω—Å
2. 50 –∑–≤—ë–∑–¥ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –≤ withdrawal_locked_balance  
3. –î–ª—è –≤—ã–≤–æ–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ 50+ –∑–≤—ë–∑–¥
4. –ü—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:
```sql
SELECT code, balance_reward, max_uses, current_uses, 
       (max_uses - current_uses) as remaining_uses
FROM promo_codes 
WHERE is_active = true 
  AND (expires_at IS NULL OR expires_at > NOW())
ORDER BY created_at DESC;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```sql
SELECT p.code, COUNT(u.id) as total_uses, 
       SUM(u.balance_granted) as total_granted
FROM promo_codes p
LEFT JOIN promo_code_uses u ON p.id = u.promo_code_id
GROUP BY p.id, p.code
ORDER BY total_uses DESC;
```

### –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```sql
SELECT u.used_at, p.code, u.balance_granted, u.withdrawal_requirement
FROM promo_code_uses u
JOIN promo_codes p ON u.promo_code_id = p.id
WHERE u.user_id = 123456
ORDER BY u.used_at DESC;
```

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è `test_promo_codes.sql` –¥–æ—Å—Ç—É–ø–Ω—ã:

- **WELCOME100** - 100 –∑–≤—ë–∑–¥, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **BONUS50** - 50 –∑–≤—ë–∑–¥, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 50
- **VIP1000** - 1000 –∑–≤—ë–∑–¥, —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 500 (—Ç–æ–ª—å–∫–æ 10 –∞–∫—Ç–∏–≤–∞—Ü–∏–π)
- **TEST123** - 25 –∑–≤—ë–∑–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **NEWYEAR2025** - 2025 –∑–≤—ë–∑–¥ (–∏—Å—Ç–µ–∫–∞–µ—Ç 1 —Ñ–µ–≤—Ä–∞–ª—è 2025)

## üéØ –†–∞—Å—à–∏—Ä–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è:

1. **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `user_id` –≤ —Ç–∞–±–ª–∏—Ü—É
2. **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `category`
3. **–ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `percentage_bonus`
4. **–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `conditions` (JSON)
5. **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `partner_id`

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è! üöÄ